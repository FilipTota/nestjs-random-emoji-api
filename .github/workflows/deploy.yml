name: Deploy

on:
  workflow_run:
    workflows: ['Tests']
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: pnpm run build

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Verify Railway CLI
        run: railway --version

      - name: Setup Railway authentication
        run: |
          echo "Setting up Railway authentication..."
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token.json
          echo "Token file created:"
          ls -la ~/.railway/
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Alternative Railway authentication
        run: |
          echo "Trying alternative authentication method..."
          export RAILWAY_TOKEN="${{ secrets.RAILWAY_TOKEN }}"
          echo "RAILWAY_TOKEN environment variable set"
        continue-on-error: true

      - name: Verify Railway token
        run: |
          echo "Verifying Railway token..."
          railway whoami

      - name: List Railway projects
        run: |
          echo "Listing available Railway projects..."
          railway list

      - name: Try to link existing project
        run: |
          echo "Attempting to link existing Railway project..."
          railway link
        continue-on-error: true

      - name: Check project status
        run: |
          echo "Checking Railway project status..."
          railway status
        continue-on-error: true

      - name: Deploy to Railway
        run: |
          echo "Deploying to Railway..."
          railway up --detach
        continue-on-error: true

      - name: Check deployment status
        run: |
          echo "Checking final deployment status..."
          railway status
        continue-on-error: true

      - name: Summary
        run: |
          echo "=== DEPLOYMENT SUMMARY ==="
          echo "Deployment process completed."
          echo "Check the logs above for any specific errors."
